<!DOCTYPE html>
<html lang="es-ES">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="UPV, Python y muchas fotos"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@seikv"/>



    <meta property="og:title" content="UPV, Python y muchas fotos &middot; Iv√°n Mart√≠n" />
    <meta property="og:site_name" content="Iv√°n Mart√≠n" />
    <meta property="og:url" content="https://ivmg.me/posts/upv-facemash/" />

    
        
            <meta property="og:image" content="/images/cover.jpg"/>
        
    

    
    <meta property="og:description" content="" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2018-12-13T21:05:45&#43;01:00" />

    
    

    <title>UPV, Python y muchas fotos &middot; Iv√°n Mart√≠n</title>

    
    <meta name="description" content="Hace m√°s o menos tres a√±os, durante una clase de Introducci√≥n a la Programaci√≥n, mandaron por el grupo de clase un enlace a una p√°gina hosteada en github. El co" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://ivmg.me/images/favicon.ico">
    <link rel="apple-touch-icon" href="https://ivmg.me/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://ivmg.me/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://ivmg.me/css/nav.css" />

    

    
    <meta name="generator" content="Hugo 0.53" />

    <link rel="canonical" href="https://ivmg.me/posts/upv-facemash/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": ,
        "logo": https://ivmg.me/images/logo.png
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "image": {
            "@type": "ImageObject",
            "url": https://ivmg.me/images/logo.png,
            "width": 250,
            "height": 250
        }, 
        
        "url": http://ivmg.me,
        "sameAs": [
            
            
             
             
             
             
             
            
        ],
        "description": Software developer ‚ô• Python
        
    },
    "headline": UPV, Python y muchas fotos,
    "name": UPV, Python y muchas fotos,
    "wordCount": 703,
    "timeRequired": "PT4M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": https://ivmg.me/posts/upv-facemash/,
    "datePublished": 2018-12-13T21:05Z,
    "dateModified": 2018-12-13T21:05Z,
    
    
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": https://ivmg.me/posts/upv-facemash/
    }
}
    </script>
    


    

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
    </ul>

    
</div>
<span class="nav-cover"></span>


<div class="site-wrapper">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>



<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
      <a class="blog-logo" href="https://ivmg.me/"><img src="https://ivmg.me/images/logo.png" alt="Home" /></a>
  
  
    
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post posts">

    <header class="post-header">
        <h1 class="post-title">UPV, Python y muchas fotos</h1>
        <small></small>

        <section class="post-meta">
        
         
        </section>
    </header>

    <section class="post-content">
      

<p>Hace m√°s o menos tres a√±os, durante una clase de Introducci√≥n a la Programaci√≥n, mandaron por el grupo de clase un enlace a una p√°gina hosteada en github. El contenido era un juego al estilo <a href="https://en.wikipedia.org/wiki/History_of_Facebook">Facemash</a>, pod√©is acceder a lo que era el juego <a href="https://web.archive.org/web/20190323204003/http://tonilopezmr.github.io/facemash/">aqu√≠</a>.</p>

<p><strong>Toda</strong> la clase se puso a jugar.</p>

<p>Al cabo de unos d√≠as la gente encargada de los sistemas hicieron cambios para que las fotos dejasen de ser accesibles sin autenticaci√≥n. Cuando intentabas acceder a la fotograf√≠a de un usuario te devolvian esta imagen:</p>

<p><img src="https://ivmg.me/images/upv-facemash/no-available.gif" alt="Link" /></p>

<h4 id="demos-paso-a-la-chapuza">Demos paso a: La chapuza üõ†</h4>

<p>Un a√±o o dos despu√©s de que hiciesen los cambios, me dio por mirar bien lo que habian hecho para bloquear el acceso. Antes de indagar supon√≠a que habr√≠an requerido autenticaci√≥n con el token de sesi√≥n y dado que ese token caduca, si a alguien le diese por usarlo para obtener todas las fotos ser√≠a tedioso. Adem√°s de que podrian ver qui√©n es.</p>

<p>Primero necesitamos saber c√≥mo se sirven las fotos.</p>

<p><img src="https://ivmg.me/images/upv-facemash/blurred-photos-link.png" alt="Link" /></p>

<p>Vemos dos rutas que nos podrian valer: <code>/foto/orla/{id}.gif</code> y <code>/foto/getb/{id}.gif</code>. Adem√°s de ver cual es mi identificador: <code>55244399</code>.</p>

<p>Cada <em>asociado</em> tiene un identificador &ldquo;aleatorio&rdquo; (ya hablaremos de esto luego üòÇ), digo <em>asociado</em> porque el sistema almacena a alumnos, empleados del campus y profesores. En el caso de que pasemos un identificador que no est√© asociado a un alumno se nos devolver√° la imagen de no disponible.</p>

<p>Bien, ahora que ya sabemos c√≥mo obtener fotos vamos a ver c√≥mo las han protegido.</p>

<p>Como he comentado antes, al protegerlas asum√≠ que lo habr√≠an hecho con el token de sesi√≥n, pero si el enlace directamente en otra pesta√±a del navegador, te devuelven que el recurso no est√° disponible. En cambio, si pulsas en algunas de las fotos de la pantalla de la orla mostrada anteriormente si que funciona.</p>

<p><img src="https://ivmg.me/images/upv-facemash/wait-what.gif" alt="Wait what" /></p>

<p>Desde el inspector, podemos copiar la petici√≥n exacta que ha hecho el navegador para obtener una imagen. Que en formato de petici√≥n cURL ser√≠a tal que:</p>

<pre><code class="language-bash">curl 'https://intranet.upv.es/foto/getb/55244399.gif'
-H 'Pragma: no-cache'
-H 'Accept-Encoding: gzip, deflate, br'
-H 'Accept-Language: es-ES,es;q=0.9,en;q=0.8'
-H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36'
-H 'Accept: image/webp,image/apng,image/*,*/*;q=0.8'
-H 'Referer: https://intranet.upv.es/pls/soalu/sic_al.lis?p_vista=intranet&amp;p_idioma=c&amp;p_caca=2018&amp;P_asi=11566&amp;P_ACTION=generarorla'
-H 'Cookie: T=foto1; AMFParams=dummy,false,false,false,false,true,mac,10_14_2,chrome,73.0.3683.75; AMFDetect=true; TDp={token}; iacclarge=; UPV_DEBUG=,iacclarge; accesible=HighContrast'
-H 'Connection: keep-alive'
-H 'Cache-Control: no-cache'
--compressed
</code></pre>

<p>Si quitamos las cosas que no nos interesan y le a√±adimos <code>--output foto.gif</code> para que nos descargue el archivo, nos quedariamos con:</p>

<pre><code class="language-bash">curl 'https://intranet.upv.es/foto/getb/55244399.gif' -H 'Referer: https://intranet.upv.es/pls/soalu/sic_al.lis?p_vista=intranet&amp;p_idioma=c&amp;p_caca=2018&amp;P_asi=11566&amp;P_ACTION=generarorla' -H 'Cookie: TDp={token};' --output foto.gif
</code></pre>

<p>Llegados a este punto, tenemos dos headers: <code>TDp</code> (el token?) y <code>Referrer</code>. Y antes ya hemos visto no tendr√≠a sentido que fuese el token el que nos permita acceder a la foto, as√≠ que la petici√≥n m√≠nima con la que nos podemos quedar es:</p>

<pre><code class="language-bash">curl 'https://intranet.upv.es/foto/getb/55244399.gif' -H 'Referer: https://intranet.upv.es/pls/soalu/sic_al.lis' --output foto.gif
</code></pre>

<p>No es una completa chapuza, ya que ahora no puedes insertar la foto en una web y que cargue. Adem√°s de que tampoco puedes cargarla de forma dinamica porque (gracias a Dios) tienen el CORS configurado. Pero si lo que querian era proteger las fotos, sin duda se podr√≠a haber hecho mejor.</p>

<p>Ah, creo que los alumnos tienen la posibilidad de configurar una web en un subdominio de <code>*.upv.es</code>, as√≠ que üëãüèº CORS.</p>

<h4 id="con-todos-ustedes-la-descarga">Con todos ustedes: La descarga ‚¨áÔ∏è</h4>

<p>Hora de montarse un dataset.</p>

<p>Lo primero que tenemos que tener en cuenta es que si queremos iterar sobre todos los identificadores que existen, nos vamos a enconrar muchas veces con la imagen de que el recurso no est√° disponible. Por lo que tenemos que encontrar alguna forma de filtrarla. Para esto podemos obtener el MD5 del archivo y listo, en este caso es: <code>eca51b6f7b2b067a1129a44557583a88</code>.</p>

<p>Este fue el script que mont√© en su momento para descargar las fotos:</p>

<pre><code class="language-python">import asyncio
import sys
from hashlib import md5

import aiofiles
from aiohttp import ClientSession, TCPConnector
from pypeln import asyncio_task as aio

limit = 1000
urls = (
    &quot;https://intranet.upv.es/foto/getb/{}.gif&quot;.format(i)
    for i in range(int(sys.argv[1]))
)
headers = {&quot;Referer&quot;: &quot;https://intranet.upv.es/pls/soalu/sic_al.lis&quot;}


async def download(url, session):
    try:
        async with session.get(url, headers=headers) as response:
            response_file = await response.read()

            m = md5()
            m.update(response_file)

            if m.hexdigest() != &quot;eca51b6f7b2b067a1129a44557583a88&quot;:
                file_name = url.split(&quot;/&quot;)[5]
                f = await aiofiles.open(f&quot;photos/{file_name}&quot;, mode=&quot;wb&quot;)
                await f.write(await response.read())
                await f.close()
    except:
        pass


aio.each(
    download,
    urls,
    workers=limit,
    on_start=lambda: ClientSession(connector=TCPConnector(limit=None)),
    on_done=lambda _status, session: session.close(),
    run=True,
)
</code></pre>

    </section>


  <footer class="post-footer">


    








<figure class="author-image">
    <a class="img" href="https://ivmg.me/" style="background-image: url(/images/logo.png)"><span class="hidden">Iv√°n Mart√≠n's Picture</span></a>
</figure>


<section class="author">
  <h4><a href="https://ivmg.me/">Iv√°n Mart√≠n</a></h4>
  
  <p>Software developer ‚ô• Python</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Valencia, Spain</span>
    <span class="author-link icon-link"><a href="http://ivmg.me">http://ivmg.me</a></span>
  </div>
</section>




    
<section class="share">
  <h4>Share this posts</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=UPV%2c%20Python%20y%20muchas%20fotos&nbsp;-&nbsp;Iv%c3%a1n%20Mart%c3%adn&nbsp;-&nbsp;@seikv&amp;url=https%3a%2f%2fivmg.me%2fposts%2fupv-facemash%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fivmg.me%2fposts%2fupv-facemash%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
</section>



    







  </footer>
</article>

</main>


  <aside class="read-next">
  
  
      <a class="read-next-story prev" style="no-cover" href="https://ivmg.me/posts/hola/">
          <section class="post">
              <h2>¬°Hola!</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Iv√°n Mart√≠n</a> </section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://ivmg.me/js/jquery.js"></script>
    <script type="text/javascript" src="https://ivmg.me/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://ivmg.me/js/index.js"></script>
    
</body>
</html>

