<!DOCTYPE html>
<html lang="es-ES">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="UPV, Python y muchas fotos"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@seikv"/>



    <meta property="og:title" content="UPV, Python y muchas fotos &middot; Iv√°n Mart√≠n" />
    <meta property="og:site_name" content="Iv√°n Mart√≠n" />
    <meta property="og:url" content="https://ivmg.me/posts/upv-facemash/" />

    
        
            <meta property="og:image" content="/images/cover.jpg"/>
        
    

    
    <meta property="og:description" content="" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2019-03-31T19:27:53&#43;02:00" />

    
    

    <title>UPV, Python y muchas fotos &middot; Iv√°n Mart√≠n</title>

    
    <meta name="description" content="Hace m√°s o menos tres a√±os, durante una clase de Introducci√≥n a la Programaci√≥n, mandaron por el grupo de clase un enlace a una p√°gina hosteada en github. El co" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://ivmg.me/images/favicon.ico">
    <link rel="apple-touch-icon" href="https://ivmg.me/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://ivmg.me/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://ivmg.me/css/nav.css" />

    

    
    <meta name="generator" content="Hugo 0.53" />

    <link rel="canonical" href="https://ivmg.me/posts/upv-facemash/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": ,
        "logo": https://ivmg.me/images/logo.png
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "image": {
            "@type": "ImageObject",
            "url": https://ivmg.me/images/logo.png,
            "width": 250,
            "height": 250
        }, 
        
        "url": http://ivmg.me,
        "sameAs": [
            
            
             
             
             
             
             
            
        ],
        "description": Software developer ‚ô• Python
        
    },
    "headline": UPV, Python y muchas fotos,
    "name": UPV, Python y muchas fotos,
    "wordCount": 1072,
    "timeRequired": "PT6M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": https://ivmg.me/posts/upv-facemash/,
    "datePublished": 2019-03-31T19:27Z,
    "dateModified": 2019-03-31T19:27Z,
    
    
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": https://ivmg.me/posts/upv-facemash/
    }
}
    </script>
    


    

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
    </ul>

    
</div>
<span class="nav-cover"></span>


<div class="site-wrapper">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>



<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
      <a class="blog-logo" href="https://ivmg.me/"><img src="https://ivmg.me/images/logo.png" alt="Home" /></a>
  
  
    
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post posts">

    <header class="post-header">
        <h1 class="post-title">UPV, Python y muchas fotos</h1>
        <small></small>

        <section class="post-meta">
        
         
        </section>
    </header>

    <section class="post-content">
      

<p>Hace m√°s o menos tres a√±os, durante una clase de Introducci√≥n a la Programaci√≥n, mandaron por el grupo de clase un enlace a una p√°gina hosteada en github. El contenido era un juego al estilo <a href="https://en.wikipedia.org/wiki/History_of_Facebook">Facemash</a>. Pod√©is acceder a lo que era el juego <a href="https://web.archive.org/web/20190323204003/http://tonilopezmr.github.io/facemash/">aqu√≠</a>.</p>

<p><strong>Toda</strong> la clase se puso a jugar.</p>

<p>Al cabo de unos d√≠as la gente encargada de los sistemas hicieron cambios para que las fotos dejasen de ser accesibles sin autenticaci√≥n. Cuando intentabas acceder a la fotograf√≠a de un usuario te devolv√≠an esta imagen:</p>

<p><img src="https://ivmg.me/images/upv-facemash/no-available.gif" alt="Link" /></p>

<h4 id="demos-paso-a-la-chapuza">Demos paso a: La chapuza üõ†</h4>

<p>Un a√±o o dos despu√©s de que hiciesen los cambios, me dio por mirar bien lo que hab√≠an hecho para bloquear el acceso. Antes de indagar supon√≠a que habr√≠an requerido autenticaci√≥n con el token de sesi√≥n y dado que ese token caduca, si a alguien le diese por usarlo para obtener todas las fotos ser√≠a tedioso. Adem√°s de que podr√≠an ver qui√©n es.</p>

<p>Primero necesitamos saber c√≥mo se sirven las fotos.</p>

<p><img src="https://ivmg.me/images/upv-facemash/blurred-photos-link.png" alt="Link" /></p>

<p>Vemos dos rutas que nos podr√≠an valer: <code>/foto/orla/{id}.gif</code> y <code>/foto/getb/{id}.gif</code>. Adem√°s de ver cual es mi identificador: <code>55244399</code>.</p>

<p>Cada <em>asociado</em> tiene un identificador &ldquo;aleatorio&rdquo;, digo <em>asociado</em> porque el sistema almacena a alumnos, empleados del campus y profesores. En el caso de que pasemos un identificador que no est√© asociado a un alumno se nos devolver√° la imagen de no disponible.</p>

<p>Bien, ahora que ya sabemos c√≥mo obtener fotos vamos a ver c√≥mo las han protegido.</p>

<p>Como he comentado antes, al protegerlas asum√≠ que lo habr√≠an hecho con el token de sesi√≥n ya que al acceder haciendo clic en la foto se abre una nueva pesta√±a cargando la imagen. Lo raro viene, cuando al copiar el enlace que hemos visto anteriormente en una nueva pesta√±a y se te muestra que el recurso no est√° disponible.</p>

<p><img src="https://ivmg.me/images/upv-facemash/wait-what.gif" alt="Wait what" /></p>

<p>Esto no tiene ning√∫n sentido ya que si la autenticaci√≥n se hiciese por algo que se guarda en el navegador dar√≠a igual que accedi√©semos a la foto copiando el enlace o clicando directamente.</p>

<p>Vamos a ver c√≥mo se est√° haciendo la llamada exactamente. Desde el inspector, podemos copiar la petici√≥n exacta que ha hecho el navegador para obtener una imagen. Que en este caso, en formato cURL ser√≠a tal que:</p>

<pre><code class="language-bash">curl 'https://intranet.upv.es/foto/getb/55244399.gif' -H 'Pragma: no-cache' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: es-ES,es;q=0.9,en;q=0.8' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36' -H 'Accept: image/webp,image/apng,image/*,*/*;q=0.8' -H 'Referer: https://intranet.upv.es/pls/soalu/sic_al.lis?p_vista=intranet&amp;p_idioma=c&amp;p_caca=2018&amp;P_asi=11566&amp;P_ACTION=generarorla' -H 'Cookie: T=foto1; AMFParams=dummy,false,false,false,false,true,mac,10_14_2,chrome,73.0.3683.75; AMFDetect=true; TDp={token}; iacclarge=; UPV_DEBUG=,iacclarge; accesible=HighContrast' -H 'Connection: keep-alive' -H 'Cache-Control: no-cache' --compressed
</code></pre>

<p>Si quitamos las cosas que no nos interesan y le a√±adimos <code>--output foto.gif</code> para que nos descargue el archivo, nos quedariamos con:</p>

<pre><code class="language-bash">curl 'https://intranet.upv.es/foto/getb/55244399.gif' -H 'Referer: https://intranet.upv.es/pls/soalu/sic_al.lis?p_vista=intranet&amp;p_idioma=c&amp;p_caca=2018&amp;P_asi=11566&amp;P_ACTION=generarorla' -H 'Cookie: TDp={token};' --output foto.gif
</code></pre>

<p>Llegados a este punto, tenemos dos headers: <code>Cookie: TDp</code> (el token?) y <code>Referrer</code>. Si s√≥lo dejamos el par√°metro <code>Referrer</code>, la fotograf√≠a se descarga, en cambio, quit√°ndolo se nos devuelve la imagen de recurso no disponible. Por lo que la petici√≥n m√≠nima con la que nos quedamos es:</p>

<pre><code class="language-bash">curl 'https://intranet.upv.es/foto/getb/55244399.gif' -H 'Referer: https://intranet.upv.es/pls/soalu/sic_al.lis' --output foto.gif
</code></pre>

<p>¬øQu√© ha pasado? Pues que, el arreglo que han hecho es a√±adir una cabecera para saber el origen desde el que se est√° accediendo al recurso.</p>

<p>Ni esto es el hackeo del siglo, ni ellos han hecho la mayor chapuza de la historia. Ahora ya no se puede insertar la foto en una web de forma directa y tampoco de forma din√°mica porque (gracias a Dios) tienen el CORS configurado. Pero si lo que quer√≠an era proteger las fotos, sin duda se podr√≠a haber hecho mejor.</p>

<p>Ah, creo que los alumnos tienen la posibilidad de configurar una web en un subdominio de <code>*.upv.es</code>, as√≠ que üëãüèº CORS.</p>

<h4 id="con-todos-ustedes-la-descarga">Con todos ustedes: La descarga ‚¨áÔ∏è</h4>

<p>Hora de montarse un dataset.</p>

<p>La idea es montar un script en python, pero un script r√°pido, muy r√°pido. Para ello vamos a usar <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a>, <a href="https://aiohttp.readthedocs.io/en/stable/">aiohttp</a> para la comunicaci√≥n, <a href="https://github.com/Tinche/aiofiles">aiofiles</a> para guardar las fotos y <a href="https://github.com/cgarciae/pypeln">pypeln</a> que nos ayudar√° con c√≥mo aiohttp hace las llamadas.</p>

<p><em>Show me the code</em>:</p>

<pre><code class="language-python">import asyncio
import hashlib
import sys

import aiofiles
from aiohttp import ClientSession, TCPConnector
from pypeln import asyncio_task as aio

urls = (f&quot;https://intranet.upv.es/foto/getb/{i}.gif&quot; for i in range(int(sys.argv[1])))
headers = {&quot;Referer&quot;: &quot;https://intranet.upv.es/pls/soalu/sic_al.lis&quot;}
hash_not_available = (
    &quot;12fc76fc961784a7568e6bbfe53559ec00e8819fdb807d44&quot;
    &quot;2735c465e938c5ee8ac060f7abe70c9fbe8b52d461379430&quot;
    &quot;637676399a793900d8221419fa5b50a5&quot;
)


async def download(url, session):
    async with session.get(url, headers=headers) as response:
        response_file = await response.read()

        if hashlib.blake2b(response_file).hexdigest() != hash_not_available:
            file_name = url.split(&quot;/&quot;)[5]

            f = await aiofiles.open(f&quot;photos/{file_name}&quot;, mode=&quot;wb&quot;)

            await f.write(await response.read())
            await f.close()


aio.each(
    download,
    urls,
    workers=1_000,
    on_start=lambda: ClientSession(connector=TCPConnector(limit=None)),
    on_done=lambda _status, session: session.close(),
    run=True,
)
</code></pre>

<p>Vamos a ver en m√°s detalle algunas partes.</p>

<pre><code class="language-python">urls = ( f&quot;https://intranet.upv.es/foto/getb/{i}.gif&quot; for i in range(int(sys.argv[1]))
)
</code></pre>

<p>Primero, tenemos que definir las URLs a las que queremos llamar, la idea es que al script se le pase por argumentos el n√∫mero de IDs hasta el que queremos iterar, para que el script tenga principio y fin, aunque si queremos iterar todas las URLs ese id va a tener que ser <strong>bastante</strong> alto. Por lo que definimos un generador, el cual empezar√° en el cero y acabar√° en <code>numero_por_argumentos - 1</code>.</p>

<pre><code class="language-python">headers = {&quot;Referer&quot;: &quot;https://intranet.upv.es/pls/soalu/sic_al.lis&quot;}
</code></pre>

<p>Aqu√≠ estamos definiendo la cabecera <em>m√°gica</em> que nos va a permitir acceder al recurso.</p>

<pre><code class="language-python">hash_not_available = &quot;12fc76fc961784a7568e6...&quot;
</code></pre>

<p>Bien, si queremos iterar sobre todos los identificadores que existen, nos vamos a encontrar muchas veces con la imagen de recurso no disponible, por lo que tenemos que encontrar alguna forma de filtrarla. Una forma r√°pida de hacerlo es comparando los hashes de los archivos, la funci√≥n en concreto que vamos a usar es <a href="https://blake2.net/">BLAKE2b</a>. Calculamos el hash para dicha foto y lo dejamos guardado en una variable para su posterior uso.</p>

<p>La parte m√°s interesante de la funci√≥n de descarga es cuando comparamos que la imagen sea distinta a la de no disponible cuanto a la funci√≥n de descarga es bastante simple, lo √∫nico interesante es cuando comparamos que la foto sea distinta a la de no disponible:</p>

<pre><code class="language-python">if hashlib.blake2b(response_file).hexdigest() != hash_not_available:
    ...
</code></pre>

<p>Adem√°s de coger el identificador de la url que estemos buscando en ese momento:</p>

<pre><code class="language-python">file_name = url.split(&quot;/&quot;)[5]
</code></pre>

<p>Por √∫ltimo, usamos pypeln para organizar el c√≥mo se van a hacer las llamadas:</p>

<pre><code class="language-python">aio.each(
    download,
    urls,
    workers=1_000,
    ...
)
</code></pre>

<p>Es interesante el par√°metro <code>workers</code>, para especificar que de forma concurrente solamente queremos estar scrapeando 1000 direcciones (que no son pocas). Cuando una de las tareas abiertas se completen se ir√°n lanzando nuevas hasta llegar a este l√≠mite.</p>

<p>Aqu√≠ podeis ver c√≥mo scrapea 2.000 IDs:</p>

<p><a href="https://asciinema.org/a/izDRrLLGqx3yIRMZU25x55BK3"><img src="https://asciinema.org/a/izDRrLLGqx3yIRMZU25x55BK3.svg" alt="asciicast" /></a></p>

<p>Ten√©is todo el c√≥digo en este repo: <a href="https://github.com/seik/upv-facemash-downloader">https://github.com/seik/upv-facemash-downloader</a></p>

    </section>


  <footer class="post-footer">


    








<figure class="author-image">
    <a class="img" href="https://ivmg.me/" style="background-image: url(/images/logo.png)"><span class="hidden">Iv√°n Mart√≠n's Picture</span></a>
</figure>


<section class="author">
  <h4><a href="https://ivmg.me/">Iv√°n Mart√≠n</a></h4>
  
  <p>Software developer ‚ô• Python</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Valencia, Spain</span>
    <span class="author-link icon-link"><a href="http://ivmg.me">http://ivmg.me</a></span>
  </div>
</section>




    
<section class="share">
  <h4>Share this posts</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=UPV%2c%20Python%20y%20muchas%20fotos&nbsp;-&nbsp;Iv%c3%a1n%20Mart%c3%adn&nbsp;-&nbsp;@seikv&amp;url=https%3a%2f%2fivmg.me%2fposts%2fupv-facemash%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fivmg.me%2fposts%2fupv-facemash%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
</section>



    







  </footer>
</article>

</main>


  <aside class="read-next">
  
  
      <a class="read-next-story prev" style="no-cover" href="https://ivmg.me/posts/hola/">
          <section class="post">
              <h2>¬°Hola!</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Iv√°n Mart√≠n</a> </section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://ivmg.me/js/jquery.js"></script>
    <script type="text/javascript" src="https://ivmg.me/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://ivmg.me/js/index.js"></script>
    
</body>
</html>

